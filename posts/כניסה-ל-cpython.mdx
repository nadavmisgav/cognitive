---
title: 住 CPython
category: 驻转
createdAt: 14.10.2022
description: Lorem
image: https://images.unsplash.com/photo-1649180556628-9ba704115795?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1162&q=80

---

## 拽

专 转拽驻 砖专爪转  转专 注
CPython,
  爪转 住  转专  驻专拽 砖专   注 .
专   拽爪转 驻砖 转 砖 转转  转 砖专 转转 住转 注  砖   住转 转拽, 驻砖专 爪 专砖 
[驻](https://bugs.python.org/)
  砖注 转.

1. [91105](https://github.com/python/cpython/issues/91105) 住驻 砖 驻住  注专转 转 `sys.tracebacklimit`.
2. [91026](https://github.com/python/cpython/issues/91026) 砖 驻专住专 砖 `urlparse`.
3. [91078](https://github.com/python/cpython/issues/91078) 拽专住 砖 住驻专 `tarfile`.

转   专  住转 驻砖  转 砖   住驻拽  砖 注转 转专转. 住祝 专爪转 转专 
CPython
  专 砖驻转专转 注转  注专   转 .


专转 爪注 砖转  驻注 
Syntax
住祝 驻转. 注砖 专注 注 砖专 转拽转 爪专 转 拽注 拽 注专 ,

```python
try
    ...
except SomeException:
    if ignore_exceptions:
        pass
    else:
        raise
```
专 专爪转 转 爪注 转 注 住 拽 砖 
`except`,
砖 注 转 转 砖转 砖拽专
`ignore_exceptions`
专拽  注专 转  专爪 转驻住 转 砖.
 转 转
Syntax
砖 ,

```python
try
    ...
except SomeException if ignore_exceptions:
    pass
```

转 砖 砖 转 砖  专  拽 住 专 拽 砖 驻   砖 专 转专 转 注砖转 转 ,
 转 驻砖 住驻专转 专转 砖 驻转  砖  拽注 拽  (注  注砖 转   转 驻注 专转).
爪转  注 转  转 砖 转 转
mailing list
砖拽专
python-ideas
专转  砖  爪注 转.
转 专转 转 砖专砖专
[驻](https://mail.python.org/archives/list/python-ideas@python.org/thread/XHT2JH5PCS73YC2PIX27MJSZY6XVE53V/#YH7A4GDAJYPG7EIRBCO5U2ESZ2IVYGUE).


砖  注     砖驻砖专 专 注专 注砖转 转  砖 专爪 驻 ,
```python
try
    ...
except SomeException if ignore_exceptions else ():
    pass
```
转    专专     专 驻 ( 砖驻砖专 专转 砖专砖专  住转 转 转转 砖),
  转 砖注砖 砖 驻 驻专专
ternary if.
专  转 转拽  砖 砖爪驻  转 
`SomeException`
  转  转拽  爪驻 
tuple
专拽 砖 砖拽 驻转  转驻住 .
驻砖专  转 拽 转专  转 ,

```python
exception_to_except = SomeException if ignore_exceptions else ()
try:
    ...
except exception_to_except:
    pass
```
转住, 住专.   转    拽砖   拽专 驻  转  转
else
专 . 注专  砖砖 爪 砖专砖专 
砖Syntax
砖  驻砖专 注砖转 转 砖转  砖 砖专拽 砖 专 驻 转   专拽
Syntax 
砖  砖 转住驻转 拽 砖驻.

  拽 转   转专   转 砖 转 转住驻转 转. 专 专砖 砖    
compiler
爪 转 砖驻转 转转,  驻 专 住 注.
 转 住 转 拽  砖转 专.

## CPython
驻专拽 砖注 注  砖 专 砖 驻转,
[CPython](https://github.com/python/cpython)
砖转
C.

 拽驻 转 专 砖转 注 转 注拽转 专
[devguide](https://devguide.python.org/).
 住祝 转
Syntax
砖专爪转  转转 驻砖    专 
`if`, `try-except`, `while`
砖.
砖专 爪专 专 砖驻转  砖驻 砖
interpeted,
注 专.
专 拽 砖 转 "拽驻" 砖驻 砖拽专转
Bytecode
砖转
Interpeter
砖 驻转 专抓.
  砖 专 转 ,   砖 驻砖   专 拽 砖  住 拽 砖 转  转 转拽 拽专 
`except`
爪专 专 专转 .
  驻砖 爪   住祝  转 拽转 砖
Syntax
砖  爪 拽驻
Bytecode
砖 转 住
`except`.

### Grammer
转 拽抓
`Grammar/python.gram`
砖专  转 拽转 砖
Syntax 砖 驻转,
[**P**arsing **E**xpression **G**rammar](https://en.wikipedia.org/wiki/Parsing_expression_grammar).
拽转 砖 拽拽 住
[PEP 617](https://peps.python.org/pep-0617/)
注砖 砖   砖注 注专 注 拽抓 拽 爪专  拽 砖驻专住专 转 砖驻.
爪注 住驻 砖
`if`
砖 拽转 砖
`except`. 驻专拽 转 转住驻转  拽 砖  拽 住专,

#### 住驻转 拽转

```diff
 except_block[excepthandler_ty]:
     | invalid_except_stmt_indent
-    | 'except' e=expression t=['as' z=NAME { z }] ':' b=block {
+    | 'except' e=expression t=['as' z=NAME { z }] c=['if' y=named_expression { y }]  ':' b=block {
```
砖   驻砖专 驻爪转
(  住专 专注)
住祝
`if`
专
`except`,
转 专转 砖 注砖   驻砖专转 住祝
`as`
专
`except`.
转  拽专 `c`.
转住驻转  砖爪专    注砖 注 转 ,

```diff
 except_block[excepthandler_ty]:
     | invalid_except_stmt_indent
     | 'except' e=expression t=['as' z=NAME { z }] c=['if' y=named_expression { y }]  ':' b=block {
-        _PyAST_ExceptHandler(e, (t) ? ((expr_ty) t)->v.Name.id : NULL, b, EXTRA) }
+        _PyAST_ExceptHandler(e, (t) ? ((expr_ty) t)->v.Name.id : NULL, b, c, EXTRA) }
```
转 转 注砖 转专转 爪 驻专住专 转 拽转 住  拽  专 驻拽爪 砖转转专 转
AST. 
转住驻转   注 专 驻拽爪 砖专  转 转.
( 拽专 驻拽爪 拽转 砖  转 转住驻转 Syntax 砖 爪专 住祝 专 砖 NULL.  专 转  驻  转 专转   专 转爪 住驻转 砖  砖.)

专 转住驻转  转 专抓
```bash
make regen-pegen
```
专转 砖 砖 拽抓 `Parser/parser.c` 砖专 注 驻专住专 砖 拽 驻转.


### AST

砖compiler
拽 
AST 
爪专 住祝 拽抓
`Parser/Python.asdl`
砖专 转 注抓 转 转专 砖   驻专专 砖住驻 驻拽爪 
`_PyAST_ExceptHandler`
   转 爪专 转.

```diff
-    excepthandler = ExceptHandler(expr? type, identifier? name, stmt* body)
+    excepthandler = ExceptHandler(expr? type, identifier? name, stmt* body, expr? ifs)
                     attributes (int lineno, int col_offset, int? end_lineno, int? end_col_offset)
```
住驻 转专转 住驻 砖 砖转 砖拽专
`ifs`
砖 转专 驻 住 砖 驻爪  住 砖
`expr`
砖 转专 砖 
python.
注转 专抓,
```bash
make regen-ast
```
专 砖 砖转 拽爪
1. `Python/Python-ast.c` - 拽抓  专 转 AST   转 住驻转 驻专专 砖注砖转 驻拽爪 `_PyAST_ExceptHandler`  Grammer 砖转砖.
2. `Include/internal/pycore_ast.h` - 拽抓 header 注 转 砖 砖 驻拽爪 `_PyAST_ExceptHandler`   转 砖拽 转  注 砖 砖, `struct _excepthandler`   `if` 砖.

  注砖 转 拽驻 转 驻转  砖 
Syntax
砖,  专注   注砖  - 专拽  专拽 
`SyntaxError`.

### 拽驻爪
驻 砖专 爪转
砖Python
注砖  拽驻 转 拽
Bytecode
转  专抓.
注转 专爪 转注专 砖 拽驻爪  注
砖Syntax
砖  专拽 
AST
  砖驻注 注
Bytecode
砖爪专.
拽抓 砖专 注 拽驻 
`Python/compile.c`
 转 专转 砖注爪 砖 砖 拽专 砖 驻
`try-except`
(转 砖砖 转专  砖转 砖注 转).

1. 驻 `except` 专.
2. 驻 `except` 砖 拽转 砖 砖转. 专 `except Exception as my_val`.

住 驻 砖    砖砖转 注 驻转, 住  砖  转 拽专 拽  砖.
转专 砖拽专 注 砖 注 转  专 砖  转 转转 转 住
`except`
`exception` 注爪!

#### except  砖
拽 砖住驻转 ,
```diff
@@ -3507,6 +3524,14 @@ compiler_try_except(struct compiler *c, stmt_ty s)
         else {
             NEW_JUMP_TARGET_LABEL(c, cleanup_body);
+            if (handler->v.ExceptHandler.ifs) {
+                if (!compiler_jump_if(c, handler->v.ExceptHandler.ifs, except, 0)) {
+                    return 0;
+                }
+            }
             ADDOP(c, POP_TOP); /* exc_value */
             USE_LABEL(c, cleanup_body);
             if (!compiler_push_fblock(c, HANDLER_CLEANUP, cleanup_body, NO_LABEL, NULL))
               return 0;
             VISIT_SEQ(c, stmt, handler->v.ExceptHandler.body);
             compiler_pop_fblock(c, HANDLER_CLEANUP, cleanup_body);
```
专 驻 住 拽 砖
`except`
拽  拽 转 注专 驻  砖
(`struct` 砖 砖转砖  注砖 爪专 转 驻 AST)
   转 转,   拽  拽 转.
拽专 转 转拽 砖 专 砖专 拽,
 转  转拽
( 0 住祝 驻拽爪)
 拽驻抓
label
砖拽专
`except`
砖专 砖, 砖驻砖 专 拽 注专 驻  砖
(砖  -  砖).

砖 
Syntax
砖  注,  砖转  注 砖 砖  砖转 转  拽  转拽
`if`
砖 拽专住.

#### 拽转 Syntax
注砖 砖 注 拽 拽
`Python/symtable.c`
砖专  注专 注
AST
爪专 转 住 砖 砖砖   
scope
砖  住.
专爪 住祝  注专  注 拽 砖
`if`
转
`AST`
砖 驻 砖.    注 砖转
Syntax
 注 住 砖 专.

```diff
@@ -1904,9 +1904,14 @@ symtable_visit_excepthandler(struct symtable *st, excepthandler_ty eh)
 {
     if (eh->v.ExceptHandler.type)
         VISIT(st, expr, eh->v.ExceptHandler.type);
     if (eh->v.ExceptHandler.name)
         if (!symtable_add_def(st, eh->v.ExceptHandler.name, DEF_LOCAL, LOCATION(eh)))
             return 0;
+    if (eh->v.ExceptHandler.ifs)
+        VISIT(st, expr, eh->v.ExceptHandler.ifs);
     VISIT_SEQ(st, stmt, eh->v.ExceptHandler.body);
     return 1;
 }
```

#### except 注 砖
注转 专爪 驻 拽注 拽 砖 爪注 砖,
```python
except Exception as e: ...
```
  拽 砖驻转 驻拽爪
`compiler_try_except`
砖注专转  砖  拽爪转 转专 住.

```diff
         if (handler->v.ExceptHandler.name) {
             NEW_JUMP_TARGET_LABEL(c, cleanup_end);
             NEW_JUMP_TARGET_LABEL(c, cleanup_body);
+            NEW_JUMP_TARGET_LABEL(c, start_body);
 
             compiler_nameop(c, handler->v.ExceptHandler.name, Store);
 
+            if (handler->v.ExceptHandler.ifs) {
+                if (!compiler_jump_if(c, handler->v.ExceptHandler.ifs, start_body, 1)) {
+                    return 0;
+                }
+                
+                compiler_nameop(c, handler->v.ExceptHandler.name, Load);
+                ADDOP_LOAD_CONST(c, Py_None);
+                compiler_nameop(c, handler->v.ExceptHandler.name, Store);
+                compiler_nameop(c, handler->v.ExceptHandler.name, Del);
+                ADDOP_JUMP(c, JUMP, except);
+            }
+            USE_LABEL(c, start_body);
```

 砖注转  砖转爪注 驻拽转
`Store`
砖转.  砖 注 驻转  砖砖转 爪
stack
砖 专  驻注转 砖  注砖 爪 
stack
转 注专 专,
砖 砖 砖
砖 砖 砖转 砖砖专
`ExceptHandler.name`.
转 爪注 拽  砖 转  驻注 注 转 转拽  拽驻抓
label
砖专转 砖拽专
`start_body`
砖 驻砖 砖 拽 砖 拽.
 转  转拽   注 注
`Load`
转 砖转 专
stack
 拽 转 砖转
(拽 砖 砖转  砖 砖 None  拽,  专专      注砖 转  砖专 驻拽爪.).
注砖 砖砖 砖 爪转
stack
  爪注 拽专
`JUMP`
转
label
砖砖转砖 拽,
`except`
砖专 驻砖 转专 转 拽专 驻  砖.

 コココ 注砖 拽注 拽  注,
```python
>>> foo = 1
>>> try:
...     raise ValueError()
... except ValueError as e if foo == 1:
...     print("Foo is 1")
Foo is 1
>>> 
>>> try:
...     raise ValueError()
... except ValueError as e if foo != 1:
...     print("Foo is 1")
Traceback (most recent call last):
  File "<stdin>", line 2, in <module>
ValueError
>>> 
```
 砖专 转   住祝 转 砖 砖注砖转
[驻](./expanding_except.diff),
注转
commit
5ecf961640
 砖 转  拽,  住祝 转 砖 砖 拽驻.
```bash
./configure
make regen-pegen
make regen-ast
make
```