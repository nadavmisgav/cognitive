---
title: 砖砖 pty
category: 拽住
createdAt: 31.08.2023
description: 专   砖  专砖 砖     tty pty. 砖转砖转 pty  爪专 remote shell 砖专 注 专砖 砖  shell 专 住祝  专转 砖   注专 专 tty driver 注砖转 砖  砖 拽 砖 转 转驻注 驻注.
image: https://images.unsplash.com/photo-1530686350401-7de25243dd89?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2071&q=80

---

## 拽

转 转 转 砖专 专 , 砖住祝 砖 砖转砖
UI
砖  驻. 专    砖专   砖 驻转 转专 专,  转专  砖砖 砖转转 专.
 专拽 转专   转 转
砖vim
砖 住驻专 拽驻 专  
shell
砖注转 转.
驻注 专砖 砖转转
remote shell
C
 转  专   驻砖 驻 驻砖专 爪注转
netcat
注砖转 转  砖专 转转

```bash
nc -l 12345 -e /bin/bash
```

  爪拽  砖转拽
UX
 注驻,  专 专  专 驻拽爪转 专转  注转 (抓 注,
`Ctrl+C`
注).

![nc reverse shell](../nc-reverse-shell.gif "nc reverse shell")


驻注 专转 砖专爪转 转
shell
专拽  
python
砖  转 专 转专 .
砖转砖转 住驻专  砖拽专转
`cli`
 驻砖转 转 专 注 砖
shell
注爪 转转  转注住拽 专拽 拽 砖 驻拽转 砖 驻 驻砖专转  专  砖 转 注
`TAB` く.
砖   驻专拽 转拽转
shell
砖专爪转 砖注 爪专 住转  专   砖  砖   注 专 拽注.


## TTY
拽住驻  住专  砖 转 转  注专转 驻注 专转, 拽爪专
tty
 砖
teletypewriter.
转  砖, 砖驻注 转 砖 驻住 , 砖专 驻注 转 住住 砖. 注砖  砖砖
转 爪专  住住转 砖 拽 驻. 砖转砖  转 驻拽 砖,   专 转 驻拽 砖拽 注 转转 专 砖注  驻住
砖 转专  拽 转 驻 专 注 祝 专.
tty
 专 砖 砖  专   驻注转  驻住  专  砖转转 专转 砖专 砖 爪专.

专
tty
 专 注  拽 砖拽  砖转砖  住
buffer
转   砖砖转砖 转  注专 转  转 
shell
砖 转 注砖 
转 砖驻 驻拽转 砖 专 转 驻 砖
tty.
注 砖   爪专 砖专 砖  爪专 转 砖拽 砖
tty
 驻砖 驻 拽
kernel.
专 驻爪转 专转 砖 拽住  转 砖转 7
tty
砖 注  爪 注
`Ctrl+Alt+F1`
砖专  住驻专 转住
tty
专 专  7 
GUI.

tty
terminal
砖  驻 专 转 砖注转 砖专 砖 转住 转 砖专转 注 转 拽住驻 砖 砖 驻注 砖 拽转 拽 驻 爪转 砖转砖  砖转  砖 .

专 砖砖  砖专  转转
userspace
 专爪转 转 驻拽爪转
砖
tty
砖 砖  
kernel
爪专
pseudoterminal
 拽爪专
pty.
转驻拽 砖  爪  转转 转 砖拽 砖注专 专
tty
砖砖 拽专 爪 砖 转转
fd
住祝 砖 转拽砖专 注 转
tty
拽  转 注 砖 注 转 砖 转转 住驻转,  专 爪专 驻砖转 .

![pty diagram](../pty-diagram.png "pty diagram")

## 转转 remote shell
拽 注砖 砖 拽爪转 转专     注   砖 专  砖拽专
pty
专爪转 住转 转
remote shell
砖, 砖 专
remote shell
 转  
ssh
. 砖 转 砖 砖 转 砖专转 
TCP
住住
C,
 拽 拽  砖爪专祝 住祝   砖  专转.
专 砖转转 砖专转 注拽专 砖 
fd
砖爪
socket
注专  砖转专 砖专转.
 专爪 砖专 转 砖专转
netcat
拽  转住  驻砖  专砖 专拽 注砖转
`dup`
砖
fd
stdin, stdout stderr
 专抓  bash.
```c
dup2(client_fd, STDIN_FILENO);
dup2(client_fd, STDOUT_FILENO);
dup2(client_fd, STDERR_FILENO);
execl("/bin/bash", "/bin/bash", NULL);
```
 砖 住专   驻爪'专 砖 专 
shell.
 转专 注  住驻拽
bash
 砖 转 爪驻  砖 
socket

tty
 拽专 砖
userspace
  驻砖 爪专 
pty
砖 砖 砖 注. 拽专 爪专转
pty

`openpty`
 注砖
`man`
注 驻拽 专 砖砖 注  驻拽转 砖拽砖专转
pty
 砖      注 转
(住驻专: 注转).
专 砖爪专转
pty
拽 砖 砖转 砖住驻拽  爪专 转 拽 砖注转 转 专 注专 

```c
openpty(&amaster, &aslave, NULL, NULL, NULL);
pid = fork()
if (0 == pid) { // child
    dup2(aslave, STDIN_FILENO);
    dup2(aslave, STDOUT_FILENO);
    dup2(aslave, STDERR_FILENO);
    execl("/bin/bash", "/bin/bash", NULL);
}

// parent
dup2(amaster, client_fd);
wait(&wstatus);
```

砖 砖 转 砖 爪专 转
pty
转 拽 砖
slave,
砖 砖专 
pty,
注专
bash.
 拽 砖
master
 转      砖 专, 拽砖专 转 驻砖 专  砖转专 ,
  专
bash
注专 专
slave
master
砖
socket,
驻.  砖转 注专 爪 拽  拽 转 拽 砖.

## client
转 砖转 砖 注爪  转 爪 砖 拽,   砖  住转转 砖转 住转,
1.  砖专转    专专  拽 专转 砖专 专抓,  驻砖  注砖 dup stdin, stdout stderr socket 砖 ?   注砖转 专拽 转   拽 砖专 住 转 专爪 砖, 砖      拽专. 转 爪专 爪专 砖 砖   input 注专 转 socket   拽砖  拽专 socket 注专 stdout.
2.  砖住驻转 转 拽 砖 注专  砖专转 拽 注 砖转专转 拽, 砖转  砖专 转  驻注   抓 注  `Ctrl+C`  砖砖  住专 转 转 转.   砖专转 netcat 拽 砖专,   .

驻 注爪 住 驻注 砖 , 砖 爪 拽  爪专 注砖转  砖 砖
tty
砖 注 转  注爪   砖驻拽转 
`Ctrl+C`
 驻  转 砖 拽  转 注  转 砖  注 
tty driver.
住 拽 砖注砖转   转 拽注 砖  注 
tty
 砖转 转
tty driver
拽专  砖转 驻注  转 砖 转 注  住驻转 拽专转
write
住驻转 注  砖转 专.

```diff
--- a/drivers/tty/tty_io.c
+++ b/drivers/tty/tty_io.c
@@ -1025,6 +1025,9 @@ static inline ssize_t do_tty_write(
                if (ret <= 0)
                        break;
 
+               ret = write(tty, file, tty->write_buf, size);
+               if (ret <= 0) break;
+
                written += ret;
```

转 专 砖  驻注 驻注,  拽 砖  驻住 砖 转.   砖专 专 砖砖转
砖shell
砖 驻    拽专 专
tty.
 专 住, 转住 砖 砖 驻爪'专 砖拽砖专
tty
砖 爪专 注砖转 爪 砖 拽 注 转 砖注 注
shell
砖专转.

1. 转 tty 转 驻爪'专 砖注砖 echo 专  专 砖 拽, 转转 驻砖 pty 爪 砖专转  转 .
2. 驻注 爪 raw, 砖注砖 专 tty  驻 砖 拽   `Ctrl+C`   驻砖 注专 转  砖 砖专转  驻 .

转   驻砖专  注砖转 注 专 拽    注   注专  砖转 转 爪 拽  注砖 驻砖 砖转砖
socat.

```bash
socat STDIN,echo=0,raw tcp-connect:127.0.0.1:8000
```

## 专 砖专转
注 注 拽 专   砖 爪 砖专转 转 砖专 转专  注 拽住,
注砖 转
砖dup
砖注砖转 
master
socket
  驻. 砖住转 专拽 转  砖专 专 砖拽 转专 砖专转  转转拽  注砖 专 拽 爪 砖.  驻注 爪专 拽 砖转  注
socket
爪注 注转拽   专 砖注
master
驻,
 专转  拽 砖转 住转转 注 注 砖砖 砖
fd
.
 转转 拽  专 砖注砖 转  砖专 注专 ,
```c
int swap(int fd1, int fd2) {
  for(;;) {
    select(...);

    if (FD_ISSET(fd1, &fds)) {
      num_bytes_read = read(fd1, buf, MAXBUF);
      write(fd2, buf, num_bytes_read);
    } else if (FD_ISSET(fd2, &fds)) {
      num_bytes_read = read(fd2, buf, MAXBUF);
      write(fd1, buf, num_bytes_read);
    }
  }
}
```


  注 砖 专祝!! 砖 拽转
shell
砖专 转 
shell
专.
专  砖 注转 
砖bash
专拽 注 砖拽砖专
group id
砖   转.

![remote shell](../remote-shell.gif "remote shell")

 拽专 砖 注 驻拽爪转 砖转 砖砖
pty
专转 砖砖 
`login_tty`
 `forkpty`
砖砖 住专 砖转 拽专
`login_tty`
注砖 驻注   砖注砖转 爪注转 转
dup 
砖 注砖转. 拽专 拽 砖
`login_tty`
专 砖 注砖  注 砖转 驻注转 砖  注砖转.

```c
int
login_tty (int fd)
{
	(void) setsid();
#ifdef TIOCSCTTY
	if (ioctl(fd, TIOCSCTTY, (char *)NULL) == -1)
		return (-1);
#else
	{
```

驻注 专砖  
`setsid`
砖爪专转 
process group 
砖
砖process
   , 专
session
拽.   转注拽转    专 住专 转 注专 砖
bash 
砖专 驻砖 爪驻 砖   砖 转 注 转 砖  转 砖  砖爪专 转转.

驻注 砖 转  拽爪转 驻转 专专 
`TIOCSCTTY`,
砖拽专 注  驻砖 转 砖 驻 转
terminal
 "砖" 注专 转
session.
   专  转住  转 爪注转
dup
砖 转 
terminal
砖, 住转 专 转 砖专 转  注 注   驻砖转 注 拽爪转 专,
转拽转 砖 砖专 砖 注砖 砖  砖  拽
bash
 专爪 爪专
session
砖
ssh.
  砖  砖拽 砖
ssh
 爪 注砖转
prompt
住住 转 砖 爪注  注砖转 转   转拽 转 注 砖. 注爪 砖
struct
拽专 砖注拽 专
session
 专  
terminal
砖 转
session
  专爪 转 拽 爪专 驻转
session
砖  爪  转
pty
砖爪专
terminal
砖.


专拽 砖专    注爪  
`forkpty`,
住祝 砖   砖住祝 驻注转 砖注砖转
`openpty`

`fork`
 爪注 砖驻
fd
 砖
tty
pty
砖爪专 process
砖,  .  驻爪转  转 拽专 转 砖驻砖 注砖 转  专  转
pid
砖爪专  
fd
砖砖
master,
砖专
slave
专 注砖  注 转  注砖 注专 转  驻注转 砖爪专 注砖转 转.

 住 拽 驻 专 转专 驻砖 专注 砖砖转砖
`forkpty`
 专 专 砖转 转  拽专 拽住 转. 拽 住驻 爪
[驻](https://gist.github.com/nadavmisgav/b744fe8443c077f54cab87fcb3b29e56),
 砖拽注转  专   砖专爪 专转 转 住祝 转  拽  注转.




