---
title: לשחק עם לינוקס
category: לינוקס
createdAt: 05.08.2022
description: 
image: https://images.unsplash.com/photo-1640552435388-a54879e72b28?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1170&q=80

---

## הקדמה

באחד מהימים רציתי לכתוב תשתית הוקים משלי.
לגבי מה זה אומר תשתית הוקים נשמור לפוסט אחר
(אם אי פעם באמת אכתוב אחת).
התשתית בתכנון תומכת גם בהוקים קרנלים וגם ב
userspace.
כאשר התחלתי לכתוב את התשתית נתקלתי בכמה בעיות, ראשית אני עובד על מחשב
Windows.
WSL2
בעיקרון יכול להריץ
kernel module
אך זה קצת מוזר לקמפל וגם זה יהיה עבור
הkernel
המוזר של
Windows.
האופציה שהייתה נראית לי טרוויאלית היא להקים מכונה וירטואלית של
PopOS,
אך מהר מאד ראיתי שגם פתרון זה מאד גרוע.
הסיבה לכך היא שבמהלך הפיתוח של
הko
ביצעתי שגיאות/נסיונות, תקראו לזה איך שבא לכם, וזה במקרה הטוב יצר לי
kernel module
שלא ניתן להסיר ובמקרה הגרוע פשוט עשה
panic.
בשני המקרים הייתי צריך לבצע
reboot
למכונה
😢.


תהליך הפיתוח המציק הזה הוביל אותי לחפש פתרון יותר טוב, כאשר הנחו אותי שתי דברים
1. התשתית צריכה לתמוך בכל ארכיטקטורה ולכן רציתי אפשרות לבצע cross-compile בהמשך הדרך.
2. התהליך של יצירת kernel עם הko שלי צריך להיות מהיר.

## qemu
[qemu](https://www.qemu.org/)
היא תשתית דיי מגניבה לאמולציה של מכונה ומה שסופר מגניב בה זה שהיא יודעת לבצע אימולציה לארכיטקטורות שונות.
כלומר אני יכול לרוץ על מחשב
x86
אבל לסמלץ
mips, שזה עונה על הצורך הראשון שלי.
בנוסף בגלל שזה אמולציה זה נטען ממש מהר ולא איכפת לי להקריס את זה וליצור חדש.
בונוס נוסף
לqemu
מכיוון שזה פשוט
process
רגיל זה אומר שניתן לדבג את הקרנל עם
gdb! (אבל זה למקרה שממש אסתבך)

### התקנה ושימוש
ההתקנה של
qemu
היא דיי פשוטה
```bash
sudo apt install qemu-system-x86
```
כאשר ניתן לבחור כל ארכיטקטורה שרוצים, אך נתחיל בפשטות
(פשטות == אותה ארכיטקטורה כמו המחשב שלכם, זה יהיה ברור למה בהמשך).
qemu
מצפה לכל מיני פרמטרים כדי לדעת מה להריץ וזה מוביל אותנו רגע להבנה של כיצד
kernel
ומערכת הפעלה linuxית
בכלל מתחילה ריצה.

## יצירת גרסת Linux משלי
אחרי לא מעט חיפושים באינרנט מצאתי
[gist](https://gist.github.com/chrisdone/02e165a0004be33734ac2334f215380e)
ממש טוב שמסביר את כל השלבים על מנת לעשות זאת.
נתחיל מלהסביר את החלקים השונים שנצטרך על מנת ליצור הפצת
linux
משל עצמנו.

1. kernel - צריך לקמפל גרסת kernel.
2. מערכת קבצים - נרצה ליצור מערכת קבצים אשר תכיל בינארים בסיסיים לעבודה עם linux.
3. init - סקריפט עליה שהkernel קופץ אליו לאחר שמעביר את המערכת למצב userspace.

### קימפול kernel
תחילה נוריד את הsource של הkernel 
[מהrepo](https://github.com/torvalds/linux/tree/v5.19)
של trovalds, נוריד את זה לתוך תקיית `/opt` שלנו.
```bash
cd /opt
sudo mkdir linux
# To prevent permission errors
sudo chown nadav linux 

cd linux
# May take some time
git clone git@github.com:torvalds/linux.git . 
```
לאחר שהורדנו נגדיר כמה משתני סביבה בשביל נוחות
```bash
export OPT=/opt
export BUILDS=/home/nadav/projects/hook_infra/mini_linux
mkdir -p $BUILDS
export LINUX=$OPT/linux
export LINUX_BUILD=$BUILDS/linux
mkdir -p $LINUX_BUILD
```




